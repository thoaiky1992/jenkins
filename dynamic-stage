pipeline {
    agent any

    environment {
        DOCKER_HUB_CREDENTIALS_USER = "thoaiky1992"
        DOCKER_HUB_CREDENTIALS_PASSWORD = "Ky@776041164"
    }
    
    stages {
        stage('Main Stage') {
            steps {
                script {
                    def stages = [
                        "Version ${TAG_VERSION}": {
                            echo "Building version ${TAG_VERSION}"
                        },
                        'Checkout': {
                            checkout([
                                $class: 'GitSCM',
                                branches: [[name: '*/master']],
                                doGenerateSubmoduleConfigurations: false,
                                extensions: [],
                                submoduleCfg: [],
                                userRemoteConfigs: [[url: 'git@github.com:thoaiky1992/jenkins.git', credentialsId: 'ssh-key-id']]
                            ])
                        },
                        'Build Docker Image': {
                            sh 'docker build -t thoaiky1992/jenkins-api:${TAG_VERSION} .'
                        },
                        'Push Docker Image': {
                            sh 'echo ${DOCKER_HUB_CREDENTIALS_PASSWORD} | docker login -u ${DOCKER_HUB_CREDENTIALS_USER} --password-stdin'
                            sh 'docker push thoaiky1992/jenkins-api:${TAG_VERSION}'
                        }
                    ]

                    stages.each { stageName, stageClosure ->
                        stage(stageName) {
                            stageClosure()
                        }
                    }
                }
            }
        }
    }
}